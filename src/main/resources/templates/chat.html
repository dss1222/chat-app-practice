<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Simple Chat</title>
    <style>
        #chat-box {
            width: 100%;
            height: 300px;
            border: 1px solid #ccc;
            overflow-y: scroll;
            margin-bottom: 10px;
        }

        #message {
            width: 80%;
        }

        #user-list {
            list-style: none;
            padding-left: 0;
        }

        #user-list li {
            padding: 4px;
        }

        #main-container {
            display: flex;
            gap: 20px;
        }

        #chat-section {
            flex: 3;
        }

        #user-section {
            flex: 1;
        }
    </style>
</head>

<body>
    <h2>ê·¸ë£¹ ì±„íŒ…</h2>
    <label for="nickname">ë‹‰ë„¤ì„:</label>
    <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„ ì…ë ¥">
    <button onclick="getToken()">í† í° ë°œê¸‰</button>
    <button onclick="connect()">ì…ì¥</button>

    <div id="main-container">
        <div id="chat-section">
            <div id="chat-box"></div>
            <input type="text" id="message" placeholder="ë©”ì‹œì§€ ì…ë ¥">
            <button onclick="sendMessage()">ì „ì†¡</button>
        </div>
        <div id="user-section">
            <h4>ì ‘ì† ì¤‘ì¸ ìœ ì €</h4>
            <ul id="user-list"></ul>
        </div>
    </div>

    <script>
        let socket = null;
        let nickname = null;
        let token = null;

        function getToken() {
            nickname = document.getElementById("nickname").value;
            if (!nickname) {
                alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”!");
                return;
            }

            fetch("/api/token?username=" + encodeURIComponent(nickname))
                .then(response => response.text())
                .then(data => {
                    token = data;
                    localStorage.setItem("access_token", token);
                    alert("í† í° ë°œê¸‰ ì™„ë£Œ!");
                })
                .catch(error => {
                    console.error("í† í° ë°œê¸‰ ì‹¤íŒ¨", error);
                });
        }

        function connect() {
            token = localStorage.getItem("access_token");

            if (!token) {
                alert("í† í°ì´ ì—†ìŠµë‹ˆë‹¤! ë¨¼ì € í† í°ì„ ë°œê¸‰ë°›ì•„ì£¼ì„¸ìš”!");
                return;
            }

            socket = new WebSocket("ws://" + window.location.host + "/ws/chat");

            socket.onopen = function () {
                const enterMessage = {
                    type: "ENTER",
                    sender: nickname,
                    message: token // í† í°ì„ ì—¬ê¸°ë¡œ ë³´ë‚´
                };
                socket.send(JSON.stringify(enterMessage));
            };


            socket.onmessage = function (event) {
                try {
                    const data = JSON.parse(event.data);

                    if (data.type === "USER_LIST") {
                        const list = document.getElementById("user-list");
                        list.innerHTML = "";
                        data.users.forEach(user => {
                            const li = document.createElement("li");
                            li.textContent = user;
                            list.appendChild(li);
                        });
                    } else {
                        appendMessage(event.data);
                    }
                } catch {
                    appendMessage(event.data);
                }
            };

            socket.onclose = function () {
                appendMessage("ğŸ”• ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            };
        }

        function sendMessage() {
            const messageBox = document.getElementById("message");
            const content = messageBox.value;
            if (socket && socket.readyState === WebSocket.OPEN && content.trim() !== "") {
                const chatMessage = {
                    type: "CHAT",
                    sender: nickname,
                    message: content
                };
                socket.send(JSON.stringify(chatMessage));
                messageBox.value = "";
            }
        }

        function appendMessage(message) {
            const chatBox = document.getElementById("chat-box");
            chatBox.innerHTML += message + "<br>";
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Enter í‚¤ ì´ë²¤íŠ¸ ì¶”ê°€
        document.addEventListener("DOMContentLoaded", function () {
            const nicknameInput = document.getElementById("nickname");
            nicknameInput.addEventListener("keypress", function (e) {
                if (e.key === "Enter") {
                    getToken(); // ë‹‰ë„¤ì„ ì…ë ¥ í›„ Enter ì¹˜ë©´ í† í° ë°œê¸‰
                }
            });

            const messageInput = document.getElementById("message");
            messageInput.addEventListener("keypress", function (e) {
                if (e.key === "Enter") {
                    sendMessage();
                }
            });
        });
    </script>
</body>

</html>
